<!DOCTYPE html>



<html lang="en-US" 
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Reading out of a sandbox: a CTF adventure" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this blog post, I’ll go through the writeup of how I and my good friend @RobHaii solved an interesting CTF challenge presented by NahamCon 2020. It was a simple implementation of a system call sandbox, and the solution was to bypass the sandbox by using already whitelisted system calls." />
<meta property="og:description" content="In this blog post, I’ll go through the writeup of how I and my good friend @RobHaii solved an interesting CTF challenge presented by NahamCon 2020. It was a simple implementation of a system call sandbox, and the solution was to bypass the sandbox by using already whitelisted system calls." />
<link rel="canonical" href="https://roberahaile.github.io/posts/reading-out-of-a-sandbox-a-CTF-adventure/" />
<meta property="og:url" content="https://roberahaile.github.io/posts/reading-out-of-a-sandbox-a-CTF-adventure/" />
<meta property="og:site_name" content="Houldini InfoSec Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-25T13:20:21+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Reading out of a sandbox: a CTF adventure" />
<meta name="twitter:site" content="@roberahaile__" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"headline":"Reading out of a sandbox: a CTF adventure","dateModified":"2021-08-25T13:20:21+03:00","datePublished":"2021-08-25T13:20:21+03:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://roberahaile.github.io/posts/reading-out-of-a-sandbox-a-CTF-adventure/"},"description":"In this blog post, I’ll go through the writeup of how I and my good friend @RobHaii solved an interesting CTF challenge presented by NahamCon 2020. It was a simple implementation of a system call sandbox, and the solution was to bypass the sandbox by using already whitelisted system calls.","url":"https://roberahaile.github.io/posts/reading-out-of-a-sandbox-a-CTF-adventure/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Reading out of a sandbox: a CTF adventure | Houldini InfoSec Blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Houldini InfoSec Blog">
<meta name="application-name" content="Houldini InfoSec Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/chilada_baboon.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Houldini's blog</a>
    </div>
    <div class="site-subtitle font-italic">Robera Haile<br>InfoSec Researcher and Hacker</div>
    <!-- <div class="site-subtitle font-italic">InfoSec Researcher and Hacker</div> -->

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <!-- <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li> -->
    <!-- the real tabs -->
    
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT ME</span>
      </a>
    </li> <!-- .nav-item -->
    
    
      
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://twitter.com/roberahaile__" aria-label="twitter"
        class="order-3"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="https://www.linkedin.com/in/roberahaile" aria-label="linkedin"
        class="order-4"
        target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
      

    
      

      
      <a href="https://github.com/RoberaHaile" aria-label="github"
        class="order-5"
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['houldini','protonmail.com'].join('@')" aria-label="email"
        class="order-6"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    

    
      
        <span class="icon-border order-2"></span>
      

      <span id="mode-toggle-wrapper" class="order-1">
        <!--
  Switch the mode between dark and light.
-->

<i class="mode-toggle fas fa-adjust"></i>

<script type="text/javascript">

  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      var self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addListener(function() {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.updateMermaid();
      });

    } /* constructor() */


    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer) ) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    updateMermaid() {
      if (typeof mermaid !== "undefined") {
        let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }

        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }

      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.updateMermaid();

    } /* flipMode() */

  } /* ModeToggle */

  let toggle = new ModeToggle();

  $(".mode-toggle").click(function() {

    toggle.flipMode();

  });

</script>

      </span>
    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
        <span>
          
          
          <a href="/">
            Posts
          </a>
        </span>

        

      

        
          <span>Reading out of a sandbox: a CTF adventure</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->




<!-- images -->



<!-- Add lang-badge for code snippets -->




<!-- return -->

<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Reading out of a sandbox: a CTF adventure</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <!-- <span class="semi-bold">
            Robera Haile
          </span> -->
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Wed, Aug 25, 2021,  1:20 PM +0300"
  

  
  prep="on" >

  
  

  
    Aug 25, 2021
  

  <i class="unloaded">2021-08-25T13:20:21+03:00</i>

</span>

          <!-- tags -->
          
          <div class="post-tags">
            <i class="fa fa-tags fa-fw mr-1"></i>
            
            <a href="/tags/pwn/"
              class="post-tag no-text-decoration" >pwn</a>
            
            <a href="/tags/linux/"
              class="post-tag no-text-decoration" >Linux</a>
            
            <a href="/tags/syscalls/"
              class="post-tag no-text-decoration" >syscalls</a>
            
            <a href="/tags/sandbox/"
              class="post-tag no-text-decoration" >sandbox</a>
            
            </div>
          
        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1920 words">10 min</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <p>In this blog post, I’ll go through the writeup of how I and my good friend <a href="https://twitter.com/RobHaii">@RobHaii</a> solved an interesting CTF challenge presented by NahamCon 2020. It was a simple implementation of a system call sandbox, and the solution was to bypass the sandbox by using already whitelisted system calls.</p>

<h2 id="what-are-system-calls">What are system calls?</h2>
<p>System calls are kernel sub-routines which allow user-space programs to request a specific service on behalf of the kernel such as network and file I/O, process creation and so on. Whenever a program calls <em>open()</em>, <em>read()</em>, <em>write()</em> or any other library function, an underlying system call is invoked, with the exception of <a href="https://man7.org/linux/man-pages/man7/vdso.7.html">virtual system calls</a>.</p>

<p>Most system calls are abstracted away from the programmer by glibc wrappers, although some of them have to be called directly (such as <em>futex()</em>). Without getting into too much details, whenever a system call is invoked, a context switch is made from the user space to kernel space by either using a legacy software interrupt, or newer fast system call methods, such as <em>sysenter()</em> and <em>syscall()</em> for 32 and 64bit systems.</p>

<p>A very good explanation of Linux system calls internals is found <a href="https://packagecloud.io/blog/the-definitive-guide-to-linux-system-calls/">here</a>.</p>

<h2 id="what-about-sandboxes">What about sandboxes?</h2>
<p>A sandbox is a security mechanism which restricts a process to a set of whitelisted actions it can perform. Although sanbox implemenations are popularized by web browsers, they are deployed in other contexts such as anti-viruses, PDF readers, mobile apps, containers and such. Even virtual machines can be considered as sandboxes where the host machine is protected from malicious actions happening in the VM. Sandboxes provide additional security protection because they restrict processes regardless of other access control mechanisms such as user IDs and permissions.</p>

<p>Userspace applications can be restricted to certain system calls in modern operating systems by mechanisms such as <a href="https://man7.org/linux/man-pages/man2/seccomp.2.html">seccomp</a> in Linux and <a href="https://man.openbsd.org/pledge.2">pledge</a> in OpenBSD.</p>

<h2 id="sytem-call-as-a-service">Sytem call-as-a-Service</h2>
<p>The aptly named challenge required the player to connect to a service which invokes the CTF binary. Upon donwloading and inspecting the binary, it turned out to be a 64bit ELF unstripped executable with debug symbols. Loading the executable in IDA pro disassembler and decompiling main results in the following pseudo-code.</p>
<h3 id="main">main()</h3>

<pre><code class="language-C">int __cdecl __noreturn main(int argc, const char **argv, const char **envp)
{
  __int64 sysno; // [rsp+8h] [rbp-48h] BYREF
  __int64 v4; // [rsp+10h] [rbp-40h] BYREF
  __int64 v5; // [rsp+18h] [rbp-38h] BYREF
  __int64 v6; // [rsp+20h] [rbp-30h] BYREF
  __int64 v7; // [rsp+28h] [rbp-28h] BYREF
  __int64 v8; // [rsp+30h] [rbp-20h] BYREF
  __int64 v9; // [rsp+38h] [rbp-18h] BYREF
  __int64 v10; // [rsp+40h] [rbp-10h]
  unsigned __int64 v11; // [rsp+48h] [rbp-8h]

  v11 = __readfsqword(0x28u);
  setup(argc, argv, envp);
  puts("Welcome to syscall-as-a-service!\n");
  while ( 1 )
  {
    printf("Enter rax (decimal): ");
    __isoc99_scanf("%ld", &amp;sysno);
    if ( (unsigned int)blacklist(sysno) )
    {
      puts("Sorry syscall is blacklisted\n");
    }
    else
    {
      printf("Enter rdi (decimal): ");
      __isoc99_scanf("%ld", &amp;v4);
      printf("Enter rsi (decimal): ");
      __isoc99_scanf("%ld", &amp;v5);
      printf("Enter rdx (decimal): ");
      __isoc99_scanf("%ld", &amp;v6);
      printf("Enter r10 (decimal): ");
      __isoc99_scanf("%ld", &amp;v7);
      printf("Enter r9 (decimal): ");
      __isoc99_scanf("%ld", &amp;v8);
      printf("Enter r8 (decimal): ");
      __isoc99_scanf("%ld", &amp;v9);
      v10 = syscall(sysno, v4, v5, v6, v7, v9, v8);
      printf("Rax: 0x%lx\n\n", v10);
    }
  }
}
</code></pre>

<p>After printing its greeting message, it goes into an infinite loop, where it reads seven long integers from the network and puts them in separate variables. It then checks the first read number (put in a variable called <em>sysno</em>) and gives it to a function called <em>blacklist()</em>, and finally based on the return value from the <em>blacklist()</em> calls, it either calls a function <em>syscall()</em> with our data-holding variables or fails with an error message.</p>

<h2 id="syscall-numbers-and-calling-conventions">Syscall numbers and calling conventions</h2>
<p>We will come to the above function later. Before that, let’s talk a little about calling conventions. Calling conventions are conventions which specify called code interfaces, such as the order of parameters passed to the callee, how parameters are passed (either by pushing on the stack or by registers or both), how return values are returned to the caller, which registers the called code must preserve for the caller code, and how stack is prepared and restored before and after the call. Calling conventions vary across different processor architectures, across different compilers in the same architecture, and even between usermode and kernel interfaces.</p>

<p>Coming to the challenge, after recieving the long integers from the user, it makes a call to <a href="https://man7.org/linux/man-pages/man2/syscall.2.html"><em>syscall()</em></a>. <em>syscall()</em> is a small library function which invokes system calls by using the appropriate system calls number. It is useful to invoke system calls which do not have glibc wrappers. Its declaration is:</p>
<pre><code class="language-C">long syscall(long number, ...);
</code></pre>
<p>It accepts a syscall number, and variable number of arguments, and returns a <em>long</em> value from the call. The variable arguments are passed to the called system call as parameters. Every system call has a unique syscall number which can be passed to <em>syscall()</em>. A system call can, and usually has different syscall number for various architectures. The list of system calls with their syscall numbers across different architectures can be found <a href="https://syscalls.w3challs.com/">here</a>.</p>

<p>Bringing back calling conventions, the kernel interface of X86_64 Linux compilers states that parameters are passed by <strong>RDI, RSI, RDX, R10, R8 and R9</strong> in order to system calls. For example, the <a href="https://man7.org/linux/man-pages/man2/write.2.html"><em>write()</em></a> system call has a unique syscall number of 1 in X86_64 and the following parameters.</p>
<pre><code class="language-C">ssize_t write(int fd, const void *buf, size_t count);
</code></pre>
<p>Therefore, <em>fd</em> parameter will be passed by <em>RDI</em>; <em>buf</em> will be passed by <em>RSI</em>; <em>count</em> will be passed by <em>RDX</em>. <em>R10</em>, <em>R8</em> and <em>R9</em> will be set to zero.</p>

<p>Thus, when invoking <em>write()</em> by using <em>syscall()</em>, it will be like this:</p>
<pre><code class="language-C">syscall(1, %RDI, %RSI, %RDX)
</code></pre>

<h2 id="the-sandbox">The sandbox</h2>
<p>Knowing this, the <a href="#main">SaaS binary</a> makes more sense now. It accepts a syscall number and puts it in <em>sysno</em>, accepts upto 6 arguments for the system call,  and calls <em>syscall()</em>, and returns the return value of the system call back to us. But before the invocation, it calls <em>blacklist()</em> with <em>sysno</em> as a parameter, and based on the return value, it succeeds to invoke our system call or fails with the message “Sorry syscall is blacklisted”. Let’s see the blacklisting function.</p>
<pre><code class="language-C">__int64 __fastcall blacklist(__int64 a1)
{
  unsigned int i; // [rsp+1Ch] [rbp-44h]
  __int64 v3[8]; // [rsp+20h] [rbp-40h]

  v3[7] = __readfsqword(0x28u);
  v3[0] = 59LL;
  v3[1] = 57LL;
  v3[2] = 56LL;
  v3[3] = 62LL;
  v3[4] = 101LL;
  v3[5] = 200LL;
  v3[6] = 322LL;
  for ( i = 0; i &lt;= 6; ++i )
  {
    if ( a1 == v3[i] )
      return 1LL;
  }
  return 0LL;
}
</code></pre>
<p>It compares our syscall number to a list of blacklisted numbers, and it matches, it will return 1. The syscall numbers listed correspond to <a href="https://man7.org/linux/man-pages/man2/execve.2.html">execve()</a>, <a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork()</a>, <a href="https://man7.org/linux/man-pages/man2/clone.2.html">clone()</a>, <a href="https://man7.org/linux/man-pages/man2/kill.2.html">kill()</a>, <a href="https://man7.org/linux/man-pages/man2/ptrace.2.html">ptrace()</a>, <a href="https://man7.org/linux/man-pages/man2/tkill.2.html">tkill()</a>, and <a href="https://man7.org/linux/man-pages/man2/timerfd_create.2.html">timerfd_create()</a>(32bit). These system calls are associated with process and thread cloning, execution of images, killing processes and threads, and timer notification. Therefore, we can’t do anything related to these tasks through the SaaS because of the blacklisting function.</p>

<h2 id="exploitation">Exploitation</h2>

<p>The plan is to read the file <em>flag.txt</em>. Since, we can’t execute commands such as <em>/bin/sh -c ‘cat flat.txt’</em> using system calls such as exec and fork. so, we will use other system calls to open the file, read its contents and and send it back to us using allowed system calls.</p>

<p>The first thing to do, therefore, would be to open the file. Searching for the man pages for system calls for opening files (or searching google) will lead us to use <em><a href="https://man7.org/linux/man-pages/man2/openat.2.html">open()</a></em>. open() system call is declared as such.</p>
<pre><code class="language-C">int open(const char *pathname, int flags);
</code></pre>
<p>So, we have to provide <em>pathname</em>, in our case <em>flag.txt</em> as a pointer to C string. But we don’t have a pointer to “flag.txt”, so we have to manually write it into a controlled memory region and pass the address of that region to open().</p>

<p>After googling about linux system calls to allocate a memory region, we will come up with <em><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap()</a></em>. The parameters and return value of mmap() is as belows.</p>
<pre><code class="language-C">void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
</code></pre>
<p>mmap() creates  a  new  mapping  in the virtual address space of the calling process. It accepts a size paramter by <em>length</em>, and starting memory address to map by <em>addr</em>. If <em>addr</em> is null, the kernel will choose a page-alligned memory region randomly. The <em>prot</em> parameter is the protection flags. For our case, we will choose (PROT_READ|PROT_WRITE) which is 0x3. The <em>flags</em> is mapping flags, and we will select (MAP_PRIVATE|MAP_ANONYMOUS). <em>MAP_ANONYMOUS</em> will ensure that the mapping is not backed up by an underlying file, and the contents are initialized to zeroes. The system call returns the address of the mapped memory region.</p>

<p>After getting our mapped memory region which is initialized to all zeros, we want to write our “flag.txt” string to it. This step will be reading our string from our socket file descriptor into our newly mapped memory buffer. A system call for this would be <em><a href="https://man7.org/linux/man-pages/man2/read.2.html">read()</a></em>. The parameters and the return value of read() is as follows.</p>
<pre><code class="language-C">ssize_t read(int fd, void *buf, size_t count);
</code></pre>
<p>So, to use read(), we have to pass the file descriptor <em>fd</em> of the our connection socket, and pass the address returned from mmap() as <em>buf</em>, and the length of <em>flag.txt</em> (8) as <em>count</em>. Assuming the server which spawns the SaaS binary also duplicates the STDIN, STDOUT and STDERR file descriptors to our socket (read <a href="https://man7.org/linux/man-pages/man2/dup.2.html">dup2()</a>), we will use STDIN (0) as input from the socket as a paramter as <em>fd</em> to read().</p>

<p>We then pass our mapped address, which now contains the string “flag.txt” to open() as <em>pathname</em> (it is null-terminated since address is initialized with zeros).</p>

<p>so far, our pseudo-C code for our solution will look like this.</p>
<pre><code class="language-C">void *address = mmap(NULL, 128, (PROT_READ|PROT_WRITE), (MAP_PRIVATE|MAP_ANONYMOUS), NULL, 0); 
read(STDIN, address, len("flag.txt")); 
int file_fd = open(address, O_RDONLY)
</code></pre>

<p>Now that we have opened the file and gotten a file descriptor, we will read the contents of the the file to a buffer, and write the read contents from the buffer to our socket. The first part is easy; we will use read() again with <em>fd</em> parameter as the file descriptor returned from the previous open() call, and the same buffer with a slight offset (not to write on the previously written “flag.txt” file name.). Our code will have one more line.</p>
<pre><code class="language-C">int read_bytes = read(file_fd, address + 20, 128); 
</code></pre>
<p>Then we will write the contents read from the previous read() call and write it to our socket (STDOUT, using our previous assumption that standard file descriptors are duplicated). Here, we will use <em><a href="https://man7.org/linux/man-pages/man2/write.2.html">write()</a></em>.</p>
<pre><code class="language-C">write(STDOUT, address + 20, read_bytes); 
</code></pre>
<p>Our final payload will look like this.</p>
<pre><code class="language-C">void *address = mmap(NULL, 128, (PROT_READ|PROT_WRITE), (MAP_PRIVATE|MAP_ANONYMOUS), NULL, 0); 
read(STDIN, address, len("flag.txt")); 
int file_fd = open(address, O_RDONLY); 
int read_bytes = read(file_fd, address + 20, 128);
write(STDOUT, address + 20, read_bytes); 
</code></pre>

<p>Translating this C code to <em>syscall()</em> with respective syscall numbers and parameters will be like this.</p>
<pre><code class="language-C">address = syscall(9, 0, 128, 3, 34, 0, 0, 0);                     //mmap() 
syscall(0, 0, address, 9, 0, 0, 0);                               //read() 
fild_fd = syscall(2, address, 0, 0, 0, 0, 0);                     //open() 
read_bytes = syscall(0, file_fd, address + 20, 128, 0, 0, 0, 0);  //read() 
syscall(1, 1, address + 20, read_bytes, 0, 0, 0, 0);              //write() 
</code></pre>

<p>Finally, we shall get our flag after the final system call (write())!. What’s left is to implement the above C code in python using <a href="https://github.com/Gallopsled/pwntools">pwntools</a> and send the appropriate parameters to <em>syscall()</em> via registers for <a href="#main">the SaaS</a>.</p>

<p>All in all, this was a very interesting and a fun challenge about a crude implementation of a system call sandbox and how to bypass it. The SaaS binary and the solution python script can be found <a href="https://github.com/RoberaHaile/ctf-solutions/tree/master/NahamCon-2020/SaaS">here</a>.</p>



      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Reading out of a sandbox: a CTF adventure - Houldini InfoSec Blog&url=https://roberahaile.github.io/posts/reading-out-of-a-sandbox-a-CTF-adventure/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=Reading out of a sandbox: a CTF adventure - Houldini InfoSec Blog&url=https://roberahaile.github.io/posts/reading-out-of-a-sandbox-a-CTF-adventure/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

  <!-- 















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

 -->

  
  <!-- 
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/evasion/">evasion</a>
      
        
        <a class="post-tag" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag" href="/tags/programming/">programming</a>
      
        
        <a class="post-tag" href="/tags/pwn/">pwn</a>
      
        
        <a class="post-tag" href="/tags/red-teaming/">Red teaming</a>
      
        
        <a class="post-tag" href="/tags/sandbox/">sandbox</a>
      
        
        <a class="post-tag" href="/tags/syscalls/">syscalls</a>
      

      </div>
    </div>
   -->
  </div> <!-- .access

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Outline</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  
    
  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->




  
    
    
  
    
    
      
      
        
        
        
      
    
  





  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/winmemfopen-a-tool-for-windows/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    Jun 12, 2021
  

  <i class="unloaded">2021-06-12T18:02:41+03:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>WinMemFopen: opening memory streams as regular files in Windows</h3>
            <div class="text-muted small">
              <p>
                





                Opening memory streams as regular files on Windows

One of my personal projects at a point was developing fully undetectable (FUD) malware in Windows environments. Now, there are a lot of elements ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/winmemfopen-a-tool-for-windows/" class="btn btn-outline-primary"
    prompt="Older">
    <p>WinMemFopen: opening memory streams as regular files in Windows</p>
  </a>
  

  
  <span class="btn btn-outline-primary disabled"
    prompt="Newer">
    <p>-</p>
  </span>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <!-- <p class="mb-0">
        © 2022
        <a href="https://twitter.com/roberahaile__">Robera Haile</a>.
        
      </p> -->
    </div>

    <!-- div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div-->

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/evasion/">evasion</a>
      
        
        <a class="post-tag" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag" href="/tags/programming/">programming</a>
      
        
        <a class="post-tag" href="/tags/pwn/">pwn</a>
      
        
        <a class="post-tag" href="/tags/red-teaming/">Red teaming</a>
      
        
        <a class="post-tag" href="/tags/sandbox/">sandbox</a>
      
        
        <a class="post-tag" href="/tags/syscalls/">syscalls</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="https://roberahaile.github.io{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- common -->

<script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>



<!-- layout specified -->


  



  <!-- image lazy-loading & popup -->
  <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>




  </body>

</html>

